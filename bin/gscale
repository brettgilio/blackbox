#!/run/current-system/profile/bin/guile -s
!#

(define-module (bin gscale)
  #:use-module (srfi srfi-1)
  #:use-module (ncurses curses)
  #:use-module (ncurses form)
  #:use-module (ncurses menu))


(define stdscr (initscr))
(start-color!)
(cbreak!)
(noecho!)
(keypad! stdscr #t)
(init-pair! 1 COLOR_RED COLOR_BLACK)

(let* (;; Labels for the main menu items
       (names '("Development   "
		"Applications"
		"Guix"
		"Nix"))
       
       (descriptions '("Spin-up preconfigured environments"
		       "Create application environments"
		       "Local and system configuration"
		       "Manage Nix properties"))

       ;; Create menu items for each label
       (main-items (map (lambda (name desc) (new-item name desc))
                      names
                      descriptions))
       ;; Create the main menu
       (main-menu (new-menu main-items))

       ;; Make a windows to hold the menu
       (main-menu-win (newwin 10 80 0 0)))

  (keypad! main-menu-win #t)

  ;; Set the main window and subwindow
  (set-menu-win! main-menu main-menu-win)
  (set-menu-sub! main-menu (derwin main-menu-win 6 60 3 1))

  ;; Set the menu mark string
  (set-menu-mark! main-menu " * ")

  ;; Print a border around the main window, and a title
  (box main-menu-win 0 0)

  (move main-menu-win 1 20)
  (addstr main-menu-win "GScale - Quick exec tool for Guix & Guile")

  (move main-menu-win 2 0)
  (addch main-menu-win (acs-ltee))
  (move main-menu-win 2 1)
  (hline main-menu-win (acs-hline) 75)
  (move main-menu-win 2 75)
  (addch main-menu-win (acs-rtee))

  (move stdscr (- (lines) 2) 0)
  (addstr stdscr "Q to quit.")
  (refresh stdscr)

  ;; Post the menu
  (post-menu main-menu)
  (refresh main-menu-win)

  ;; Draw the menu
  (move stdscr (- (lines) 2) 0)
  (addstr stdscr "Q to quit.")

  ;; Process the up and down arrow keys.  Break the loop if F1 is
  ;; pressed.  Ignore other keys.
  (let loop ((c (getch main-menu-win)))
    (cond

     ;; Move down the menu when down arrow is pressed and then loop.
     ((eqv? c KEY_DOWN)
      (begin
        (menu-driver main-menu REQ_DOWN_ITEM)
        (loop (getch main-menu-win))))

     ;; Move up the menu when the up arrow is pressed and then loop.
     ((eqv? c KEY_UP)
      (begin
        (menu-driver main-menu REQ_UP_ITEM)
        (loop (getch main-menu-win))))

     ;; When enter is pressed, return the selection and quit.
     ((or (eqv? c KEY_ENTER)
          (eqv? c #\cr)
          (eqv? c #\nl))
      (begin
        (unpost-menu main-menu)
        (move stdscr (- (lines) 4) 0)
        (addstr stdscr
                (format #f "You selected item #~a: ~a"
                        (item-index (current-item main-menu))
                        (item-name (current-item main-menu))))
        (refresh stdscr)
        (sleep 2)))

     ;; If F1 is pressed, quit.  Otherwise, loop.
     ((not (or (eqv? c #\Q) (eqv? c #\q)))
      (loop (getch stdscr)))))

  (endwin))
